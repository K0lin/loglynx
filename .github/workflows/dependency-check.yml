name: Dependency Security Check

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  vulnerability-scan:
    name: Check for known vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
        
      - name: Run vulnerability check
        run: |
          echo "Checking for known vulnerabilities in dependencies..."
          govulncheck ./...
          
  outdated-check:
    name: Check for outdated dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          
      - name: Check for outdated direct dependencies
        run: |
          echo "Checking for outdated dependencies..."
          echo "Direct dependencies:"
          go list -u -m all | grep -E "\[direct\]" -A1 -B1 || echo "No outdated direct dependencies found"
          
      - name: List all dependencies with available updates
        run: |
          echo "All dependencies with available updates:"
          go list -u -m -json all | jq -r '"\(.Path): current=\(.Version) latest=\(.Update.Version // "none")"' | grep -v "none$" || echo "No dependencies have updates available"
          
  security-scan:
    name: Run security analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          
      - name: Install Gosec
        run: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        
      - name: Run security scan
        run: |
          echo "Running security scan..."
          gosec -no-fail -fmt json -out gosec-report.json ./...
          
      - name: Upload security scan results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: gosec-report
          path: gosec-report.json
          retention-days: 30
          
  license-check:
    name: Check dependency licenses
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
          
      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest
        
      - name: Check licenses
        run: |
          echo "Checking dependency licenses..."
          go-licenses check ./...
          echo ""
          echo "License summary:"
          go-licenses csv ./... | sort | uniq -c | sort -nr
          
      - name: Save license report
        run: |
          go-licenses csv ./... > license-report.csv
          
      - name: Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: license-report
          path: license-report.csv
          retention-days: 30
